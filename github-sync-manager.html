<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘å·¥åŠ - GitHubè‡ªåŠ¨åŒæ­¥ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-6xl mx-auto p-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-4">ğŸ”„ äº‘å·¥åŠ - GitHubè‡ªåŠ¨åŒæ­¥ç®¡ç†</h1>
            <p class="text-gray-600">é…ç½®GitHubè‡ªåŠ¨åŒæ­¥ï¼Œå®ç°è·¨è®¾å¤‡æ•°æ®è‡ªåŠ¨åŒæ­¥</p>
        </div>

        <!-- å¼•å…¥GitHubåŒæ­¥è„šæœ¬ -->
        <script src="github-sync.js"></script>

        <!-- å½“å‰çŠ¶æ€ -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">ğŸ“Š åŒæ­¥çŠ¶æ€</h2>
            <div id="sync-status" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="text-sm font-medium text-blue-900">è¿æ¥çŠ¶æ€</div>
                    <div id="connection-status" class="text-2xl font-bold text-blue-600">æ£€æŸ¥ä¸­...</div>
                    <div class="text-xs text-blue-700">GitHubè¿æ¥çŠ¶æ€</div>
                </div>
                <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                    <div class="text-sm font-medium text-green-900">è‡ªåŠ¨åŒæ­¥</div>
                    <div id="auto-sync-status" class="text-2xl font-bold text-green-600">æ£€æŸ¥ä¸­...</div>
                    <div class="text-xs text-green-700">è‡ªåŠ¨åŒæ­¥çŠ¶æ€</div>
                </div>
                <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <div class="text-sm font-medium text-purple-900">æœ€ååŒæ­¥</div>
                    <div id="last-sync-time" class="text-2xl font-bold text-purple-600">æ£€æŸ¥ä¸­...</div>
                    <div class="text-xs text-purple-700">æœ€ååŒæ­¥æ—¶é—´</div>
                </div>
                <div class="p-4 bg-orange-50 rounded-lg border border-orange-200">
                    <div class="text-sm font-medium text-orange-900">ç”¨æˆ·æ•°é‡</div>
                    <div id="user-count" class="text-2xl font-bold text-orange-600">æ£€æŸ¥ä¸­...</div>
                    <div class="text-xs text-orange-700">åŒæ­¥çš„ç”¨æˆ·æ•°é‡</div>
                </div>
            </div>
        </div>

        <!-- é…ç½®åŒºåŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- GitHubé…ç½® -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ”§ GitHubé…ç½®</h3>
                
                <div id="config-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">GitHub Personal Access Token</label>
                        <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">
                            <a href="https://github.com/settings/tokens" target="_blank" class="text-blue-600 hover:underline">è·å–Token</a> 
                            (éœ€è¦gistæƒé™)
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Gist ID (å¯é€‰)</label>
                        <input type="text" id="gist-id" placeholder="ç•™ç©ºå°†åˆ›å»ºæ–°çš„Gist" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">å¦‚æœå·²æœ‰Gistï¼Œè¯·è¾“å…¥IDï¼›å¦åˆ™å°†åˆ›å»ºæ–°çš„</p>
                    </div>
                    
                    <button onclick="initializeSync()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        åˆå§‹åŒ–åŒæ­¥
                    </button>
                </div>
                
                <div id="connected-info" class="hidden space-y-4">
                    <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                        <div class="text-sm font-medium text-green-900">âœ… å·²è¿æ¥</div>
                        <div class="text-xs text-green-700 mt-1">Gist ID: <span id="current-gist-id"></span></div>
                    </div>
                    
                    <button onclick="disconnectSync()" class="w-full bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        æ–­å¼€è¿æ¥
                    </button>
                </div>
            </div>

            <!-- åŒæ­¥æ§åˆ¶ -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">âš™ï¸ åŒæ­¥æ§åˆ¶</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è‡ªåŠ¨åŒæ­¥é—´éš”</label>
                        <select id="sync-interval" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="1">1åˆ†é’Ÿ</option>
                            <option value="5" selected>5åˆ†é’Ÿ</option>
                            <option value="10">10åˆ†é’Ÿ</option>
                            <option value="30">30åˆ†é’Ÿ</option>
                            <option value="60">1å°æ—¶</option>
                        </select>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="startAutoSync()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            å¯åŠ¨è‡ªåŠ¨åŒæ­¥
                        </button>
                        <button onclick="stopAutoSync()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            åœæ­¢è‡ªåŠ¨åŒæ­¥
                        </button>
                    </div>
                    
                    <button onclick="manualSync()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        ç«‹å³åŒæ­¥
                    </button>
                </div>
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">ğŸ”‘ è·å–GitHub Tokenï¼š</h4>
                    <ol class="text-sm text-gray-600 space-y-1 list-decimal list-inside">
                        <li>è®¿é—® <a href="https://github.com/settings/tokens" target="_blank" class="text-blue-600 hover:underline">GitHub Tokenè®¾ç½®</a></li>
                        <li>ç‚¹å‡»"Generate new token"</li>
                        <li>é€‰æ‹©"Gist"æƒé™</li>
                        <li>å¤åˆ¶ç”Ÿæˆçš„Token</li>
                    </ol>
                </div>
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">ğŸ”„ è‡ªåŠ¨åŒæ­¥åŠŸèƒ½ï¼š</h4>
                    <ul class="text-sm text-gray-600 space-y-1 list-disc list-inside">
                        <li>è‡ªåŠ¨æ£€æµ‹æ•°æ®å˜åŒ–</li>
                        <li>æ™ºèƒ½åˆå¹¶å¤šè®¾å¤‡æ•°æ®</li>
                        <li>æ”¯æŒç¦»çº¿ä½¿ç”¨</li>
                        <li>æ•°æ®å®‰å…¨åŠ å¯†å­˜å‚¨</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- åŒæ­¥æ—¥å¿— -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ“‹ åŒæ­¥æ—¥å¿—</h3>
            <div id="sync-log" class="bg-gray-100 p-4 rounded-lg h-64 overflow-y-auto text-sm font-mono">
                <div class="text-gray-500">ç­‰å¾…æ“ä½œ...</div>
            </div>
            <div class="mt-4 flex space-x-2">
                <button onclick="clearLog()" class="px-4 py-2 bg-gray-600 text-white rounded-lg text-sm hover:bg-gray-700">
                    æ¸…é™¤æ—¥å¿—
                </button>
                <button onclick="exportLog()" class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700">
                    å¯¼å‡ºæ—¥å¿—
                </button>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="text-center space-x-4">
            <a href="admin-users.html" class="inline-flex items-center px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                <i data-lucide="users" class="h-5 w-5 mr-2"></i>
                ç”¨æˆ·ç®¡ç†
            </a>
            <a href="user-sync.html" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                <i data-lucide="refresh-cw" class="h-5 w-5 mr-2"></i>
                æ‰‹åŠ¨åŒæ­¥
            </a>
            <a href="navigation.html" class="inline-flex items-center px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                <i data-lucide="navigation" class="h-5 w-5 mr-2"></i>
                å¯¼èˆªä¸­å¿ƒ
            </a>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–Lucideå›¾æ ‡
        lucide.createIcons();

        // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        function checkAdminPermission() {
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) {
                showPermissionError('è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·');
                return false;
            }
            
            try {
                const user = JSON.parse(currentUser);
                if (user.role !== 'admin') {
                    showPermissionError('åªæœ‰ç®¡ç†å‘˜æ‰èƒ½è®¿é—®æ­¤é¡µé¢');
                    return false;
                }
                return true;
            } catch (error) {
                showPermissionError('ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                return false;
            }
        }

        // æ˜¾ç¤ºæƒé™é”™è¯¯
        function showPermissionError(message) {
            const container = document.querySelector('.max-w-6xl');
            container.innerHTML = `
                <div class="text-center py-16">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="shield-x" class="h-8 w-8 text-red-600"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-900 mb-4">è®¿é—®è¢«æ‹’ç»</h1>
                    <p class="text-gray-600 mb-8">${message}</p>
                    <div class="space-x-4">
                        <button onclick="window.location.href='index.html'" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                            è¿”å›ç™»å½•é¡µé¢
                        </button>
                        <button onclick="window.location.href='admin-dashboard.html'" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                            ç®¡ç†å‘˜æ§åˆ¶å°
                        </button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('sync-log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-600',
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-yellow-600'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = `mb-1 ${colors[type]}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLog() {
            document.getElementById('sync-log').innerHTML = '<div class="text-gray-500">æ—¥å¿—å·²æ¸…é™¤</div>';
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLog() {
            const logContent = document.getElementById('sync-log').innerText;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `github-sync-log-${new Date().toISOString().split('T')[0]}.log`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus() {
            const status = window.githubSync.getStatus();
            const users = window.githubSync.getLocalUsers();
            
            // è¿æ¥çŠ¶æ€
            document.getElementById('connection-status').textContent = status.isInitialized ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
            document.getElementById('connection-status').className = status.isInitialized ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-red-600';
            
            // è‡ªåŠ¨åŒæ­¥çŠ¶æ€
            document.getElementById('auto-sync-status').textContent = status.isAutoSyncActive ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
            document.getElementById('auto-sync-status').className = status.isAutoSyncActive ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-gray-600';
            
            // æœ€ååŒæ­¥æ—¶é—´
            if (status.lastSyncTime) {
                document.getElementById('last-sync-time').textContent = status.lastSyncTime.toLocaleTimeString();
            } else {
                document.getElementById('last-sync-time').textContent = 'ä»æœªåŒæ­¥';
            }
            
            // ç”¨æˆ·æ•°é‡
            document.getElementById('user-count').textContent = users.length;
            
            // æ˜¾ç¤º/éšè—é…ç½®è¡¨å•
            if (status.isInitialized) {
                document.getElementById('config-form').classList.add('hidden');
                document.getElementById('connected-info').classList.remove('hidden');
                document.getElementById('current-gist-id').textContent = status.gistId;
            } else {
                document.getElementById('config-form').classList.remove('hidden');
                document.getElementById('connected-info').classList.add('hidden');
            }
        }

        // åˆå§‹åŒ–åŒæ­¥
        async function initializeSync() {
            if (!checkAdminPermission()) return;
            
            const token = document.getElementById('github-token').value.trim();
            const gistId = document.getElementById('gist-id').value.trim();
            
            if (!token) {
                alert('è¯·è¾“å…¥GitHub Personal Access Token');
                return;
            }
            
            addLog('æ­£åœ¨åˆå§‹åŒ–GitHubåŒæ­¥...', 'info');
            
            try {
                const result = await window.githubSync.initialize(token, gistId || null);
                
                if (result.success) {
                    addLog(`GitHubåŒæ­¥åˆå§‹åŒ–æˆåŠŸï¼Gist ID: ${result.gistId}`, 'success');
                    alert(`âœ… GitHubåŒæ­¥åˆå§‹åŒ–æˆåŠŸï¼\n\nGist ID: ${result.gistId}\n\nè¯·ä¿å­˜æ­¤IDï¼Œä»¥ä¾¿åœ¨å…¶ä»–è®¾å¤‡ä¸Šä½¿ç”¨ã€‚`);
                    updateStatus();
                } else {
                    addLog(`åˆå§‹åŒ–å¤±è´¥: ${result.error}`, 'error');
                    alert(`âŒ åˆå§‹åŒ–å¤±è´¥: ${result.error}`);
                }
            } catch (error) {
                addLog(`åˆå§‹åŒ–é”™è¯¯: ${error.message}`, 'error');
                alert(`âŒ åˆå§‹åŒ–é”™è¯¯: ${error.message}`);
            }
        }

        // æ–­å¼€è¿æ¥
        function disconnectSync() {
            if (!checkAdminPermission()) return;
            
            if (confirm('ç¡®å®šè¦æ–­å¼€GitHubåŒæ­¥è¿æ¥å—ï¼Ÿ')) {
                window.githubSync.disconnect();
                addLog('å·²æ–­å¼€GitHubåŒæ­¥è¿æ¥', 'warning');
                updateStatus();
            }
        }

        // å¯åŠ¨è‡ªåŠ¨åŒæ­¥
        function startAutoSync() {
            if (!checkAdminPermission()) return;
            
            const interval = parseInt(document.getElementById('sync-interval').value);
            window.githubSync.startAutoSync(interval);
            addLog(`è‡ªåŠ¨åŒæ­¥å·²å¯åŠ¨ï¼Œé—´éš”: ${interval}åˆ†é’Ÿ`, 'success');
            updateStatus();
        }

        // åœæ­¢è‡ªåŠ¨åŒæ­¥
        function stopAutoSync() {
            if (!checkAdminPermission()) return;
            
            window.githubSync.stopAutoSync();
            addLog('è‡ªåŠ¨åŒæ­¥å·²åœæ­¢', 'warning');
            updateStatus();
        }

        // æ‰‹åŠ¨åŒæ­¥
        async function manualSync() {
            if (!checkAdminPermission()) return;
            
            addLog('å¼€å§‹æ‰‹åŠ¨åŒæ­¥...', 'info');
            
            try {
                const users = await window.githubSync.syncUsers();
                addLog(`æ‰‹åŠ¨åŒæ­¥æˆåŠŸï¼åŒæ­¥äº† ${users.length} ä¸ªç”¨æˆ·`, 'success');
                updateStatus();
            } catch (error) {
                addLog(`æ‰‹åŠ¨åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
                alert(`âŒ æ‰‹åŠ¨åŒæ­¥å¤±è´¥: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
            if (!checkAdminPermission()) {
                return;
            }
            
            addLog('GitHubåŒæ­¥ç®¡ç†é¡µé¢å·²åŠ è½½', 'info');
            updateStatus();
            
            // å¦‚æœå·²è¿æ¥ï¼Œæ˜¾ç¤ºå½“å‰Gist ID
            const status = window.githubSync.getStatus();
            if (status.isInitialized) {
                document.getElementById('current-gist-id').textContent = status.gistId;
            }
        });
    </script>
</body>
</html> 